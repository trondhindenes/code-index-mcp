name: Publish to MCP Registry

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write
  id-token: write  # Required for GitHub OIDC authentication

jobs:
  publish:
    name: Publish to MCP Registry
    runs-on: ubuntu-latest
    # Only run if CI succeeded and created a release, or if manually triggered
    if: >
      (github.event_name == 'workflow_dispatch') ||
      (github.event.workflow_run.conclusion == 'success')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Manual trigger - use input
            TAG="${{ inputs.version }}"
          else
            # Triggered by CI workflow - get latest release tag
            TAG=$(gh release list --limit 1 --json tagName -q '.[0].tagName')
          fi

          VERSION="${TAG#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Using version: $VERSION (tag: $TAG)"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if release exists
        id: check_release
        run: |
          if gh release view "${{ steps.version.outputs.tag }}" > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "::error::Release ${{ steps.version.outputs.tag }} does not exist"
            exit 1
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install mcp-publisher
        run: |
          # Download the latest mcp-publisher release
          curl -sL https://github.com/modelcontextprotocol/registry/releases/download/v1.3.9/mcp-publisher_linux_amd64.tar.gz | tar xz
          chmod +x mcp-publisher
          sudo mv mcp-publisher /usr/local/bin/

      - name: Update manifest.json version
        run: |
          jq --arg v "${{ steps.version.outputs.version }}" '.version = $v' manifest.json > manifest.tmp.json
          mv manifest.tmp.json manifest.json

      - name: Download binaries and package MCPB bundles
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          mkdir -p downloads bundles

          # Download all release assets
          gh release download "$TAG" --dir downloads --pattern "*.tar.gz"
          ls -la downloads/

          # Package each platform into MCPB bundle
          platforms=(
            "darwin-amd64"
            "darwin-arm64"
            "linux-amd64"
            "linux-arm64"
          )

          for platform in "${platforms[@]}"; do
            echo "Packaging $platform..."

            # Extract binary from tarball
            tar -xzf "downloads/code-index-mcp-${platform}.tar.gz" -C downloads

            # Create MCPB bundle directory
            bundle_dir="bundle-$platform"
            mkdir -p "$bundle_dir"

            # Copy manifest and binary
            cp manifest.json "$bundle_dir/"
            cp downloads/code-index-mcp "$bundle_dir/"

            # Create MCPB bundle (ZIP file)
            bundle_name="code-index-mcp-${platform}.mcpb"
            cd "$bundle_dir"
            zip -r "../bundles/$bundle_name" .
            cd ..

            # Compute SHA256
            sha256sum "bundles/$bundle_name" | awk '{print $1}' > "bundles/$bundle_name.sha256"

            # Cleanup
            rm -rf "$bundle_dir" downloads/code-index-mcp
          done

          ls -la bundles/
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate server.json with packages
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${{ steps.version.outputs.tag }}"
          REPO="trondhindenes/code-index-mcp"

          # Read SHA256 hashes
          SHA_DARWIN_AMD64=$(cat bundles/code-index-mcp-darwin-amd64.mcpb.sha256)
          SHA_DARWIN_ARM64=$(cat bundles/code-index-mcp-darwin-arm64.mcpb.sha256)
          SHA_LINUX_AMD64=$(cat bundles/code-index-mcp-linux-amd64.mcpb.sha256)
          SHA_LINUX_ARM64=$(cat bundles/code-index-mcp-linux-arm64.mcpb.sha256)

          cat > server.json << EOF
          {
            "\$schema": "https://static.modelcontextprotocol.io/schemas/2025-10-17/server.schema.json",
            "name": "io.github.trondhindenes/code-index-mcp",
            "title": "Code Index",
            "description": "Fast local source code searching using Zoekt trigram-based indexing",
            "version": "$VERSION",
            "repository": {
              "url": "https://github.com/$REPO",
              "source": "github"
            },
            "packages": [
              {
                "registryType": "mcpb",
                "identifier": "https://github.com/$REPO/releases/download/$TAG/code-index-mcp-darwin-amd64.mcpb",
                "version": "$VERSION",
                "fileSha256": "$SHA_DARWIN_AMD64",
                "transport": { "type": "stdio" }
              },
              {
                "registryType": "mcpb",
                "identifier": "https://github.com/$REPO/releases/download/$TAG/code-index-mcp-darwin-arm64.mcpb",
                "version": "$VERSION",
                "fileSha256": "$SHA_DARWIN_ARM64",
                "transport": { "type": "stdio" }
              },
              {
                "registryType": "mcpb",
                "identifier": "https://github.com/$REPO/releases/download/$TAG/code-index-mcp-linux-amd64.mcpb",
                "version": "$VERSION",
                "fileSha256": "$SHA_LINUX_AMD64",
                "transport": { "type": "stdio" }
              },
              {
                "registryType": "mcpb",
                "identifier": "https://github.com/$REPO/releases/download/$TAG/code-index-mcp-linux-arm64.mcpb",
                "version": "$VERSION",
                "fileSha256": "$SHA_LINUX_ARM64",
                "transport": { "type": "stdio" }
              }
            ]
          }
          EOF

          cat server.json

      - name: Upload MCPB bundles to release
        run: |
          gh release upload "${{ steps.version.outputs.tag }}" bundles/*.mcpb --clobber
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to MCP Registry
        run: |
          mcp-publisher login github-oidc
          mcp-publisher publish --file server.json
